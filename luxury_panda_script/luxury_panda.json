{
    "script": {
        "lang": "mustache",
            "source": "{\r\n      \"size\": {{view}}{{^view}}10{{/view}},\r\n      \"from\": {{from}}{{^from}}0{{/from}},\r\n      \"sort\" : [\r\n        {{#stock_sort}}\r\n        {\r\n          \"stock_cnt\" : {\r\n            \"missing\" : \"_last\"\r\n          }\r\n        },{{/stock_sort}}\r\n        {{#sort_field}}\r\n        {\"{{sort_field}}\":\"{{sort_order}}{{^sort_order}}asc{{/sort_order}}\"},\r\n        {{/sort_field}}\r\n        {\r\n          \"id\" : \"asc\"\r\n        }\r\n      ],\r\n      {{#last_value}}\r\n      \"search_after\": [\r\n        \"{{last_value}}\"\r\n        ],{{/last_value}}\r\n      \"query\": {\r\n        \"bool\": {\r\n          \"filter\" : [\r\n\t\t\t\t{\r\n\t\t\t\t  \"exists\" : {\r\n\t\t\t\t\t\"field\" : \"name\"\r\n\t\t\t\t  }\r\n\t\t\t\t}\r\n\t\t\t\t{{^sellable}},\r\n\t\t\t\t{\r\n\t\t\t\t  \"match\": {\r\n\t\t\t\t\t\"display_desktop\": {\r\n\t\t\t\t\t  \"query\": true\r\n\t\t\t\t\t}\r\n\t\t\t\t  }\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t  \"match\": {\r\n\t\t\t\t\t\"display_mobile\": {\r\n\t\t\t\t\t  \"query\": true\r\n\t\t\t\t\t}\r\n\t\t\t\t  }\r\n\t\t\t\t}\r\n\t\t\t\t{{/sellable}}{{#sellable}},\r\n\t\t\t\t{\r\n\t\t\t\t  \"match\": {\r\n\t\t\t\t\t\"display_desktop\": {\r\n\t\t\t\t\t  \"query\": true\r\n\t\t\t\t\t}\r\n\t\t\t\t  }\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t  \"match\": {\r\n\t\t\t\t\t\"display_mobile\": {\r\n\t\t\t\t\t  \"query\": true\r\n\t\t\t\t\t}\r\n\t\t\t\t  }\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t  \"bool\": {\r\n\t\t\t\t\t\"should\": [\r\n\t\t\t\t\t  {\r\n\t\t\t\t\t\t\"bool\": {\r\n\t\t\t\t\t\t  \"must_not\": [\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t  \"exists\": {\r\n\t\t\t\t\t\t\t\t\"field\": \"scheduled_start_at\"\r\n\t\t\t\t\t\t\t  }\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t  ]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t  },\r\n\t\t\t\t\t  {\r\n\t\t\t\t\t\t\"bool\": {\r\n\t\t\t\t\t\t  \"must\": [\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t  \"range\": {\r\n\t\t\t\t\t\t\t\t\"scheduled_start_at\": {\r\n\t\t\t\t\t\t\t\t  \"lte\": \"now/d\"\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t  }\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t  \"range\": {\r\n\t\t\t\t\t\t\t\t\"scheduled_end_at\": {\r\n\t\t\t\t\t\t\t\t  \"gte\": \"now/d\"\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t  }\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t  ]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t  }\r\n\t\t\t\t\t]\r\n\t\t\t\t  }\r\n\t\t\t\t}{{/sellable}}{{#path}},\r\n\t\t\t\t{\r\n\t\t\t\t  \"term\" : {\r\n\t\t\t\t\t\"category_path.hierarchy\" : \"{{path}}\"\r\n\t\t\t\t  }\r\n\t\t\t\t}{{/path}}{{#hashTags}},\r\n\t\t\t\t{\r\n\t\t\t\t  \"match\" : {\r\n\t\t\t\t\t\"hash_tags\" : \"{{hashTags}}\"\r\n\t\t\t\t  }\r\n\t\t\t\t}{{/hashTags}}{{#brand_id}},\r\n\t\t\t\t{\r\n\t\t\t\t  \"match\" : {\r\n\t\t\t\t\t\"main_brand_id\" : \"{{brand_id}}\"\r\n\t\t\t\t  }\r\n\t\t\t\t}{{/brand_id}}{{#priceMin}},\r\n\t\t\t\t{\r\n\t\t\t\t \"range\": {\r\n\t\t\t\t\t\"price\": {\r\n\t\t\t\t\t  \"gt\": {{priceMin}} \r\n\t\t\t\t  }\r\n\t\t\t\t}\r\n\t\t\t\t}{{/priceMin}}{{#priceMax}},\r\n\t\t\t\t{\r\n\t\t\t\t \"range\": {\r\n\t\t\t\t\t\"price\": {\r\n\t\t\t\t\t  \"lte\": {{priceMax}} \r\n\t\t\t\t  }\r\n\t\t\t\t}\r\n\t\t\t\t}{{/priceMax}}{{#has_stock}},\r\n\t\t\t\t{\r\n\t\t\t\t  \"range\" : {\r\n\t\t\t\t\t\"stock_cnt\" : {\r\n\t\t\t\t\t  \"gt\" : 0\r\n\t\t\t\t\t}\r\n\t\t\t\t  }\r\n\t\t\t\t}{{/has_stock}}{{^has_stock}},\r\n\t\t\t\t{\r\n\t\t\t\t  \"range\" : {\r\n\t\t\t\t\t\"stock_cnt\" : {\r\n\t\t\t\t\t  \"gte\" : 0\r\n\t\t\t\t\t}\r\n\t\t\t\t  }\r\n\t\t\t\t}{{/has_stock}}\r\n\t\t\t  ],\r\n          \"must\" : [\r\n            {{#point_in_time}}\r\n            {\r\n              \"range\" : {\r\n                \"updated_at\" : {\r\n                  \"lte\" : \"{{point_in_time}}\"\r\n                }\r\n              }\r\n            },{{/point_in_time}}\r\n            {\r\n              \"bool\" : {\r\n                \"should\" : [\r\n      \t\t\t\t\t  {{#search}}\r\n      \t\t\t\t\t  {\r\n        \t\t\t\t\t\t\"match\" : {\r\n        \t\t\t\t\t\t  \"search.nori\" : {\r\n          \t\t\t\t\t\t\t\"query\" : \"{{search}}\",\r\n          \t\t\t\t\t\t\t\"operator\" : \"and\",\r\n          \t\t\t\t\t\t\t\"analyzer\" : \"nori_analyzer_search\"\r\n        \t\t\t\t\t\t  }\r\n        \t\t\t\t\t\t}\r\n      \t\t\t\t\t  },\r\n      \t\t\t\t\t  {\r\n        \t\t\t\t\t\t\"match\" : {\r\n        \t\t\t\t\t\t  \"model_number\" : \"{{search}}\"  \r\n        \t\t\t\t\t\t}\r\n      \t\t\t\t\t  }{{/search}}\r\n      \t\t\t\t\t]\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      },{{#currency}}\r\n      \"runtime_mappings\": {\r\n        \"exchange\": {\r\n          \"type\": \"double\",\r\n            \"script\" : {\r\n              \"source\": \"if (params.currency == 'USD') { if (doc['currency'].value == 'KRW') {emit(doc['price'].value * {{krw}});} else if (doc['currency'].value == 'USD') {emit(doc['price'].value * {{usd}});} } else if (params.currency == 'KRW') { if (doc['currency'].value == 'KRW') {emit(doc['price'].value * {{krw}});} else if (doc['currency'].value == 'USD') {emit(doc['price'].value * {{usd}});} }\",\r\n              \"params\" : {\r\n                \"currency\" : \"{{currency}}\"\r\n              }\r\n            }\r\n        }\r\n      },{{/currency}}\r\n      \"_source\" : [\r\n                    \"id\",\r\n                    \"name\",\r\n                    \"main_brand_name_en\",\r\n                    \"main_brand_name\",\r\n                    \"images\",\r\n                    \"service_price\",\r\n                    \"list_price\",\r\n                    \"price\",\r\n                    \"option_names\",\r\n                    \"option_stocks\",\r\n                    \"hash_tags\",\r\n                    \"model_number\",\r\n                    \"stock_cnt\"{{#sort_field}},\r\n                    \"{{sort_field}}\"\r\n{{/sort_field}}                  ],\r\n      \"aggs\": {\r\n        \"count\": {\r\n          \"value_count\": {\r\n            \"field\": \"id\"\r\n          }\r\n        }{{#use_agg_event}},\r\n        \"agg_event\": {\r\n          \"terms\": {\r\n            \"field\": \"category_path.hierarchy\",\r\n            \"size\": 10000,\r\n            \"include\" : \"event.*\"\r\n          }\r\n        }{{/use_agg_event}}{{#use_agg_list}},\r\n        \"agg_list\": {\r\n          \"terms\": {\r\n            \"field\": \"category_path.hierarchy\",\r\n            \"size\": 10000,\r\n            \"include\" : \"list.*\"\r\n          }\r\n        }{{/use_agg_list}}{{#use_agg_hotdeal}},\r\n        \"agg_hotdeal\": {\r\n          \"terms\": {\r\n            \"field\": \"category_path.hierarchy\",\r\n            \"size\": 10000,\r\n            \"include\" : \"hotdeal.*\"\r\n        }\r\n      }{{/use_agg_hotdeal}}{{#use_agg_brand}},\r\n        \"agg_brand_id\": {\r\n          \"terms\": {\r\n            \"field\": \"brand_nm_id\",\r\n            \"size\": 10000,\r\n            \"order\": {\r\n              \"_count\": \"desc\"\r\n            }\r\n          }\r\n        }{{/use_agg_brand}}{{#use_krw_interval}},\r\n\t\t\t\"price_hist\": {\r\n\t\t\t  \"range\": {\r\n        \"field\": \"exchange\",\r\n        \"ranges\": [\r\n          { \"from\": 100000, \"to\": 500000 },\r\n          { \"from\": 500000, \"to\": 1000000 },\r\n          { \"from\": 1000000, \"to\": 3000000 },\r\n          { \"from\": 3000000, \"to\": 5000000 },\r\n          { \"from\": 5000000 }\r\n        ]\r\n      }\r\n\t\t\t}{{/use_krw_interval}}{{#use_usd_interval}},\r\n\t\t\t\"price_hist\": {\r\n\t\t\t  \"range\": {\r\n        \"field\": \"exchange\",\r\n        \"ranges\": [\r\n          { \"from\": 100, \"to\": 500 },\r\n          { \"from\": 500, \"to\": 1000 },\r\n          { \"from\": 1000, \"to\": 3000 },\r\n          { \"from\": 3000, \"to\": 5000 },\r\n          { \"from\": 5000 }\r\n          ]\r\n\t\t\t }\r\n      }{{/use_usd_interval}}\r\n      },\r\n      \"fields\" : [\"exchange\"]\r\n      },\r\n      \"highlight\" : {\r\n        \"fields\" : {\r\n          \"*\" : {}\r\n        }\r\n      }\r\n    }\r\n    "
        }
}

